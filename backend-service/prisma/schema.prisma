// Prisma schema for SheetIsSmart

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Model for Authentication
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sheets                Sheet[]
  sharesCreated         SheetShare[]   @relation("ShareCreator")
  sharesReceived        SheetShare[]   @relation("ShareRecipient")
  rowComments           RowComment[]
  notificationsReceived Notification[] @relation("NotificationRecipient")
  notificationsSent     Notification[] @relation("NotificationSender")
  favorites             UserFavorite[]

  @@map("users")
}

// Core Models for MVP - Sheet functionality

model Sheet {
  id          String   @id @default(cuid())
  name        String
  description String?
  userId      String
  isFavorite  Boolean  @default(false)
  shareToken  String?  @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  columns           Column[]
  rows              Row[]
  cells             Cell[]
  shares            SheetShare[]
  conditionalFormats ConditionalFormat[]
  favoritedBy       UserFavorite[]

  @@map("sheets")
}

model Column {
  id        String   @id @default(cuid())
  sheetId   String
  name      String
  type      ColumnType @default(TEXT)
  position  Int
  width     Int?     @default(150)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sheet     Sheet    @relation(fields: [sheetId], references: [id], onDelete: Cascade)
  cells     Cell[]

  @@unique([sheetId, position])
  @@map("columns")
}

model Row {
  id        String   @id @default(cuid())
  sheetId   String
  name      String?  // Optional custom name for the row
  position  Int
  height    Int?     @default(35)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sheet     Sheet       @relation(fields: [sheetId], references: [id], onDelete: Cascade)
  cells     Cell[]
  comments  RowComment[]

  @@unique([sheetId, position])
  @@map("rows")
}

model Cell {
  id             String   @id @default(cuid())
  sheetId        String
  rowId          String
  columnId       String
  value          String?  // Store as JSON string for complex types
  formula        String?  // Formula starting with =
  computedValue  String?  // Computed result of formula

  // Cell Formatting
  textColor      String?  // Hex color (e.g., "#000000")
  backgroundColor String? // Hex color (e.g., "#FFFFFF")
  fontSize       Int?     @default(14) // Font size in pixels
  bold           Boolean  @default(false)
  italic         Boolean  @default(false)
  underline      Boolean  @default(false)
  textAlign      String?  @default("left") // "left", "center", "right"
  hasBorder      Boolean  @default(false)
  numberFormat   String?  @default("general") // "general", "number", "currency", "percentage", "date"
  decimalPlaces  Int?     @default(2)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  sheet     Sheet       @relation(fields: [sheetId], references: [id], onDelete: Cascade)
  row       Row         @relation(fields: [rowId], references: [id], onDelete: Cascade)
  column    Column      @relation(fields: [columnId], references: [id], onDelete: Cascade)

  @@unique([rowId, columnId])
  @@index([sheetId])
  @@map("cells")
}

model ConditionalFormat {
  id            String              @id @default(cuid())
  sheetId       String
  name          String              // Rule name for easy identification
  ruleType      FormatRuleType      // Type of condition
  condition     String              // JSON string: condition details (e.g., {"operator": ">", "value": 100})
  backgroundColor String?           // Hex color or CSS color
  textColor     String?             // Hex color or CSS color
  bold          Boolean             @default(false)
  italic        Boolean             @default(false)
  priority      Int                 @default(0) // Higher priority rules apply first
  range         String              // Cell range (e.g., "A1:B10" or specific cells)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  // Relations
  sheet         Sheet               @relation(fields: [sheetId], references: [id], onDelete: Cascade)

  @@index([sheetId])
  @@map("conditional_formats")
}

model RowComment {
  id        String   @id @default(cuid())
  rowId     String
  userId    String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  row           Row            @relation(fields: [rowId], references: [id], onDelete: Cascade)
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  notifications Notification[]

  @@index([rowId])
  @@map("row_comments")
}

model Notification {
  id         String           @id @default(cuid())
  userId     String           // Who receives the notification
  fromUserId String           // Who triggered the notification
  type       NotificationType
  isRead     Boolean          @default(false)

  // Related data for navigation
  sheetId    String?
  rowId      String?
  commentId  String?

  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  // Relations
  user       User             @relation("NotificationRecipient", fields: [userId], references: [id], onDelete: Cascade)
  fromUser   User             @relation("NotificationSender", fields: [fromUserId], references: [id], onDelete: Cascade)
  comment    RowComment?      @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@map("notifications")
}

// User-specific favorites (allows shared users to favorite sheets)
model UserFavorite {
  id        String   @id @default(cuid())
  userId    String
  sheetId   String
  createdAt DateTime @default(now())

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  sheet     Sheet    @relation(fields: [sheetId], references: [id], onDelete: Cascade)

  @@unique([userId, sheetId])
  @@map("user_favorites")
}

// Sheet Sharing Model
model SheetShare {
  id             String         @id @default(cuid())
  sheetId        String
  sharedById     String
  sharedWithId   String?
  sharedWithEmail String
  permission     SharePermission @default(VIEWER)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // Relations
  sheet          Sheet          @relation(fields: [sheetId], references: [id], onDelete: Cascade)
  sharedBy       User           @relation("ShareCreator", fields: [sharedById], references: [id], onDelete: Cascade)
  sharedWith     User?          @relation("ShareRecipient", fields: [sharedWithId], references: [id])

  @@unique([sheetId, sharedWithEmail])
  @@map("sheet_shares")
}

// Enums
enum ColumnType {
  TEXT
  NUMBER
  DATE
  DROPDOWN
  CHECKBOX
  FORMULA
}

enum NotificationType {
  MENTION      // Someone mentioned you in a comment
  COMMENT      // Someone commented on a sheet you own
  SHARE        // Someone shared a sheet with you
}

enum SharePermission {
  VIEWER
  EDIT
  EDIT_CAN_SHARE
}

enum FormatRuleType {
  CELL_VALUE          // Based on cell value (>, <, =, !=, between, etc.)
  TEXT_CONTAINS       // If text contains specific string
  DATE_IS             // Date-based rules (today, yesterday, in the past, etc.)
  DUPLICATE_VALUES    // Highlight duplicates
  UNIQUE_VALUES       // Highlight unique values
  TOP_BOTTOM          // Top/bottom N values or percentages
  ABOVE_BELOW_AVERAGE // Above/below average
  FORMULA_CUSTOM      // Custom formula-based rule
}
